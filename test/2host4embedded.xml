<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<beast namespace="beast.core
                  :beast.core.parameter
                  :beast.core.util
                  :beast.evolution.alignment
                  :beast.evolution.operators
                  :beast.util
                  :cophy
                  :cophy.operator"
       version="2.0">

    <taxonSet id="hostTaxa" spec="TaxonSet">
        <taxon id="host1" spec="Taxon"/>
        <taxon id="host2" spec="Taxon"/>
    </taxonSet> 

    <treeParser id="hostTree"
                IsLabelledNewick="true"
                taxonset="@hostTaxa"
                newick="(host1:1.0,host2:1.0);"
                spec="TreeParser"/>

    <taxonSet id="embeddedTaxa" spec="TaxonSet">
        <taxon id="embedded1" spec="Taxon"/>
        <taxon id="embedded2" spec="Taxon"/>
        <taxon id="embedded3" spec="Taxon"/>
        <taxon id="embedded4" spec="Taxon"/>
    </taxonSet>

    <distribution id="posterior"
                  ignore="false"
                  spec="util.CompoundDistribution"
                  useThreads="false">
    
        <distribution id="prior"
                      ignore="false"
                      spec="util.CompoundDistribution"
                      useThreads="false">

            <distribution id="cophylogeny"
                          spec="cophy.model.ThresholdedCophylogenyModel"
                          threshold="4"
                          embeddedTree="@embeddedTree"
                          hostTree="@hostTree">
                <reconciliation id="reconciliation"
                                value="0"
                                embeddedTree="@embeddedTree"
                                hostTree="@hostTree"
                                spec="Reconciliation">
                    <hostTrait spec="beast.evolution.tree.TraitSet"
                           traitname="host"
                           value="embedded1 = host1,
                                  embedded2 = host2,
                                  embedded3 = host1,
                                  embedded4 = host2"
                           taxa="@embeddedTaxa"/>
                    <parameter id="originHeight" name="originHeight" value="4.0"/>
                </reconciliation>
                <parameter name="duplicationRate" value="1.0"/>
                <parameter name="hostSwitchRate" value="1.0"/>
                <parameter name="lossRate" value="1.0"/>
                <originHeight idref="originHeight"/>
                <clockModel spec="beast.evolution.branchratemodel.StrictClockModel">
                    <parameter name="clock.rate" estimate="false" value="1.0"/>
                </clockModel>
            </distribution>

        </distribution>
    
    </distribution>

    <run id="mcmc"
         chainLength="1000000"
         preBurnin="0"
         sampleFromPrior="False"
         spec="MCMC"> 

        <state id="state">
             <stateNode estimate="true"
                  taxonset="@embeddedTaxa"
                  spec="beast.evolution.tree.RandomTree">
                <populationModel spec="beast.evolution.tree.coalescent.ConstantPopulation">
                    <parameter name="popSize" value="1"/>
                </populationModel>
            </stateNode>
            <stateNode idref="hostTree"/>
            <stateNode idref="reconciliation"/>
            <stateNode idref="originHeight"/>
        </state>

        <distribution idref="posterior"/>

        <operator spec="ScaleOperator"
                  scaleFactor="0.5"
                  weight="1"
                  tree="@embeddedTree"/>
        <operator spec="Uniform" weight="10" tree="@embeddedTree"/>
        <operator spec="SubtreeSlide"
                  weight="5"
                  gaussian="true"
                  size="1.0"
                  tree="@embeddedTree"/>
        <operator spec="Exchange"
                  isNarrow="true"
                  weight="1"
                  tree="@embeddedTree"/>
        <operator spec="Exchange"
                  isNarrow="false"
                  weight="1"
                  tree="@embeddedTree"/>
        <operator spec="WilsonBalding" weight="1" tree="@embeddedTree"/>
        <operator spec="HostSwitchOperator"
                  embeddedTree="@embeddedTree"
                  hostTree="@hostTree"
                  reconciliation="@reconciliation"
                  originHeight="@originHeight"
                  weight="1"/>
        <operator spec="LeafHostSwitchOperator"
                  embeddedTree="@embeddedTree"
                  hostTree="@hostTree"
                  reconciliation="@reconciliation"
                  originHeight="@originHeight"
                  weight="1"/>
        <operator spec="CospeciationOperator"
                  embeddedTree="@embeddedTree"
                  reconciliation="@reconciliation"
                  originHeight="@originHeight"
                  weight="1"/>
        
        <logger logEvery="10000">
            <log idref="prior"/>
        </logger>
        <logger logEvery="100" fileName="$(filebase).$(seed).trees">
            <log spec="beast.evolution.tree.TreeWithMetaDataLogger"
                 tree="@embeddedTree">
                <metadata idref="reconciliation"/>
            </log>
        </logger>
    </run>

</beast>
